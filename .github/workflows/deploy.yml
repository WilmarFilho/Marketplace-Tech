name: Deploy Marketplace

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 1. Entrar na pasta do projeto ou criar se não existir
            mkdir -p ~/Marketplace-Tech
            cd ~/Marketplace-Tech
            
            # 2. Verificar se a pasta já é um repositório Git
            if [ ! -d ".git" ]; then
              echo "Limpando pasta para clone inicial (incluindo arquivos ocultos)..."
              # Remove tudo, incluindo arquivos que começam com ponto, para o clone não falhar
              find . -mindepth 1 -delete
              git clone https://github.com/WilmarFilho/Marketplace-Tech.git .
            else
              echo "Repositório detectado. Sincronizando com a Main..."
              git fetch origin main
              git reset --hard origin/main
            fi

            # 3. Executar o Docker Compose
            # O script testa se o comando é 'docker compose' (v2) ou 'docker-compose' (v1)
            if docker compose version > /dev/null 2>&1; then
              echo "Usando Docker Compose V2"
              docker compose up -d --build
            else
              echo "Usando Docker Compose V1"
              docker-compose up -d --build
            fi

            # 4. Limpeza opcional de imagens antigas para não encher o disco da VPS
            docker image prune -f